<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Bestie Court: Shashwat vs Apoorva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat Scrollbar */
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai"
      }
    }
    </script>
</head>
<body class="bg-slate-950 text-slate-100 antialiased selection:bg-rose-500 selection:text-white overflow-x-hidden">

    <!-- Background Effects -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/10 rounded-full blur-[120px]"></div>
    </div>

    <!-- Main App Container -->
    <div id="root" class="relative z-10 container mx-auto px-4 py-8 md:py-12 min-h-screen flex flex-col">
        <!-- Content will be injected here by JS -->
    </div>

    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, push, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIyIXYNvVhJnSK58rB29K9n7SNnbaoqnc",
            authDomain: "proposal-apoorva-sarvagy.firebaseapp.com",
            databaseURL: "https://proposal-apoorva-sarvagy-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "proposal-apoorva-sarvagy",
            storageBucket: "proposal-apoorva-sarvagy.firebasestorage.app",
            messagingSenderId: "794226715688",
            appId: "1:794226715688:web:284222db7af709b2cd591d",
            measurementId: "G-BZ4R12MR9T"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Generate Session ID
        const getISTString = () => {
            const date = new Date();
            return date.toLocaleString('en-GB', { 
                timeZone: 'Asia/Kolkata', 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            }).replace(/[/:, ]/g, '_');
        };
        
        const SESSION_ID = `session_${getISTString()}`;
        const sessionRef = ref(db, `question sites sessions/${SESSION_ID}`);

        // Logger Function
        const actionCounters = {}; 

        const logAction = (action, payload) => {
            try {
                let keyBase = action;
                // Prepend Case ID if available
                if (payload && payload.caseId) {
                    const simpleCaseName = payload.caseId.replace('case-', '').toUpperCase();
                    keyBase = `${simpleCaseName}_${action}`;
                }

                // Handle Indexing
                if (!actionCounters[keyBase]) {
                    actionCounters[keyBase] = 1;
                } else {
                    actionCounters[keyBase]++;
                }
                const count = actionCounters[keyBase];
                const finalKey = count === 1 ? keyBase : `${keyBase}_${count}`;

                const logRef = child(sessionRef, `logs/${finalKey}`);
                set(logRef, {
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: payload
                });
            } catch (err) {
                console.error("Logging failed:", err);
            }
        };

        logAction("SESSION_START", {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            screenSize: `${window.innerWidth}x${window.innerHeight}`
        });

        // --- GEMINI CONFIG ---
        const API_KEY = "AIzaSyBO1YEmsOjSjyIFh3Yg81vjk9yOmcQTAfg"; 
        const ai = new GoogleGenAI({ apiKey: API_KEY });
        const MODEL_ID = 'gemini-flash-latest';

        // --- ICONS ---
        const Icons = {
            User: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Phone: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
            Instagram: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>`,
            Question: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>`,
            Gavel: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 13-7.5 7.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L11 10"/><path d="m16 16 6-6"/><path d="m8 8 6-6"/><path d="m9 7 8 8"/><path d="m21 11-8-8"/></svg>`,
            Send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`
        };

        // --- DATA ---
        const shashwatStats = {
            name: "Shashwat",
            height: "5'8\"",
            skinTone: "Fair",
            role: "PCM + CS (11th)",
            rank: "#4-5 (Almost Top)",
            details: ["Software Dev (Java)", "2.8K+ LinkedIn Followers", "23+ Certifications", "5‚òÖ HackerRank (Java)", "Movie Buff üé¨"],
            highlight: "Developed Prod-Level Apps üíª",
            image: "https://picsum.photos/seed/shashwat/200/200" 
        };

        const apoorvaStats = {
            name: "Apoorva",
            height: "5'5\"",
            skinTone: "Dusky",
            role: "PCM + Biotech (11th)",
            rank: "School Topper üèÜ",
            details: ["Writes Journals ‚úçÔ∏è", "Horse Riding üèá", "Reads Books üìö", "Movie Hater üö´", "10/10 Acting Skills üé≠"],
            highlight: "Master Manipulator üòà",
            image: "./res/photo-9.png"
        };

        const CASES = [
            {
                id: 'case-gatekeeping',
                title: 'The Gatekeeping Scandal',
                description: "Shashwat has introduced 3-4 friends to Apoorva. Apoorva has introduced ZERO friends to Shashwat. She even hides her sister. Why is she gatekeeping her social circle?",
                severity: 'CRITICAL',
                context: "The user (Shashwat) is upset because he introduces his bestie (Apoorva) to everyone, but she hides him from her friends and even her sister. They've only met once due to different schools, but talk constantly on Instagram. Apoorva is a topper and manipulates situations.",
                opener: "The prosecution calls Apoorva Maurya to the stand. The charge is Social Gatekeeping. You've met Shashwat's friends, yet his existence remains a secret to yours. Explain yourself."
            },
            {
                id: 'case-insta-fraud',
                title: 'The Instagram ID Fraud',
                description: "Breach of Contract: We agreed to a mutual exchange of Instagram IDs. She tried to avoid it, and when she finally gave it, she changed the password mid-way to lock me out.",
                severity: 'HIGH',
                context: "Shashwat and Apoorva agreed to swap Instagram logins. Shashwat honored the deal. Apoorva hesitated, then gave the ID, but stealthily changed the password mid-way to revoke access. This is deceptive behavior.",
                opener: "We are here to discuss the Instagram Treaty. You provided credentials and then revoked access via a password change. Is this how you honor a contract?"
            },
            {
                id: 'case-privacy-breach',
                title: 'The Spoiler Surveillance',
                description: "Violation of Privacy: She reads my DMs with Rishika (another friend) and ruins her own surprises because I send drafts to Rishika for review first. This is an offense to my privacy.",
                severity: 'HIGH',
                context: "Shashwat plans surprises for Apoorva and sends drafts to their mutual friend Rishika for review. Apoorva snoops into Shashwat's DMs with Rishika, reads about the surprise, and ruins the moment. This violates Shashwat's privacy rights.",
                opener: "You stand accused of spoiling your own surprises by snooping in private DMs between Shashwat and Rishika. Why do you hate joy?"
            },
            {
                id: 'case-manipulation',
                title: 'The Puppet Master',
                description: "Psychological Manipulation: She manipulates me into doing things I don't want to‚Äîlike giving up my ID or stopping my 'dalal harkate' (matchmaking) between her and Sarvagy.",
                severity: 'CRITICAL',
                context: "Apoorva uses her 10/10 acting skills to manipulate Shashwat. She forces him to give her his ID against his will and stops him from playfully matchmaking ('dalal harkate') her with their friend Sarvagy. Shashwat feels regretful and sad after being manipulated.",
                opener: "The plaintiff claims you use 10/10 acting skills to force his hand‚Äîspecifically regarding his ID and his matchmaking efforts with Sarvagy. How do you plead?"
            },
            {
                id: 'case-underwhelming-reaction',
                title: 'The Appreciation Deficit',
                description: "Emotional Damage: I spend 10-20 hours coding dedicated websites for her. Her reaction? A dry 'good' or 'cute'. This is insufficient compensation for the hard work.",
                severity: 'MEDIUM',
                context: "Shashwat is a developer who spends 10-20 hours building custom websites for Apoorva. Apoorva, being non-technical, gives very dry reactions like 'it's good' or 'cute', which hurts Shashwat's feelings as he expects more enthusiasm for his hard work.",
                opener: "The plaintiff spent 20 hours coding a website for you. Your response was a single word: 'Cute'. Do you have any idea how much caffeine went into that code?"
            },
            {
                id: 'case-physical-assault',
                title: 'The Battery Charge',
                description: "Physical Violence: She beats me whenever we meet. On our first and only meetup, she hit me 40+ times. I do not consent to this violence.",
                severity: 'HIGH',
                context: "Apoorva is physically aggressive. When they met for the first time, she hit/beat Shashwat 40+ times playfully but painfully. Shashwat hates this and wants it to stop.",
                opener: "Exhibit A: Bruises. You struck the plaintiff 40+ times during a single meeting. Is this affection or assault?"
            }
        ];

        // --- STATE ---
        let currentSession = {
            activeCaseId: null,
            chatHistory: [], // { role: 'prosecutor' | 'defendant', text: string }
            credibility: 100, // 0 to 100
            status: 'OPEN', // OPEN, GUILTY, ACQUITTED
            isProcessing: false
        };

        // --- COMPONENTS ---
        
        const renderProfileCard = (stats, align) => {
            const isLeft = align === 'left';
            const alignClass = isLeft ? 'items-start text-left' : 'items-end text-right';
            const colorClass = isLeft ? 'text-blue-400' : 'text-rose-400';
            const bgClass = isLeft ? 'bg-blue-600' : 'bg-rose-600';
            const borderClass = isLeft ? 'text-blue-200' : 'text-rose-200';

            const detailsHtml = stats.details.map(d => `
                <li class="flex items-center gap-2">
                    ${isLeft ? '<span class="w-1 h-1 rounded-full bg-blue-500"></span>' : ''}
                    ${d}
                    ${!isLeft ? '<span class="w-1 h-1 rounded-full bg-rose-500"></span>' : ''}
                </li>
            `).join('');

            return `
                <div class="flex flex-col ${isLeft ? 'items-start' : 'items-end'} w-full max-w-sm glass-panel p-6 rounded-2xl border-t border-white/10 shadow-2xl transition-transform hover:scale-105 duration-300">
                    <div class="relative mb-4">
                        <div class="absolute -inset-1 rounded-full blur opacity-50 ${bgClass}"></div>
                        <img src="${stats.image}" alt="${stats.name}" class="relative w-28 h-28 rounded-full object-cover border-4 border-slate-900" />
                    </div>
                    <h3 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 mb-1">${stats.name}</h3>
                    <p class="text-xs font-bold uppercase tracking-widest mb-4 ${colorClass}">${stats.role}</p>
                    <div class="w-full space-y-3 ${alignClass}">
                        <div class="flex flex-col ${isLeft ? 'items-start' : 'items-end'}">
                            <span class="text-[10px] uppercase tracking-wider text-slate-500">Stats</span>
                            <span class="text-base text-slate-200 font-medium">${stats.height} ‚Ä¢ ${stats.skinTone}</span>
                        </div>
                        <div class="flex flex-col ${isLeft ? 'items-start' : 'items-end'}">
                            <span class="text-[10px] uppercase tracking-wider text-slate-500">Rank</span>
                            <span class="text-base text-slate-200 font-medium">${stats.rank}</span>
                        </div>
                        <div class="flex flex-col ${isLeft ? 'items-start' : 'items-end'} mt-2">
                            <span class="text-xs uppercase tracking-wider text-slate-500 mb-1">Key Attributes</span>
                            <ul class="text-sm text-slate-300 space-y-1 ${alignClass}">${detailsHtml}</ul>
                        </div>
                        <div class="mt-4 px-3 py-2 rounded bg-slate-800/50 border border-slate-700/50 text-xs ${borderClass}">
                            ${stats.highlight}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCaseCard = (c) => {
            const colorMap = {
                CRITICAL: 'text-red-500 border-red-500/50 bg-red-500/10',
                HIGH: 'text-orange-500 border-orange-500/50 bg-orange-500/10',
                MEDIUM: 'text-yellow-500 border-yellow-500/50 bg-yellow-500/10',
                LOW: 'text-blue-500 border-blue-500/50 bg-blue-500/10'
            };
            const severityClass = colorMap[c.severity] || colorMap.LOW;

            return `
                <div onclick="window.setActiveCase('${c.id}')" class="group cursor-pointer glass-panel p-6 rounded-xl border-l-4 border-l-slate-600 hover:border-l-purple-500 transition-all duration-300 hover:translate-y-[-4px]">
                    <div class="flex justify-between items-start mb-4">
                        <div class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${severityClass}">
                            ${c.severity} Priority
                        </div>
                        <div class="w-5 h-5 text-slate-600 group-hover:text-purple-400 transition-colors">${Icons.Gavel}</div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-100 mb-2 group-hover:text-purple-300 transition-colors">${c.title}</h3>
                    <p class="text-slate-400 text-sm mb-6 line-clamp-3">${c.description}</p>
                    <div class="flex items-center text-xs font-mono text-slate-500">
                        <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                        COURT IN SESSION
                    </div>
                </div>
            `;
        };

        const renderChatMessage = (msg, idx) => {
            const isProsecutor = msg.role === 'prosecutor';
            return `
                <div class="flex w-full mb-6 animate-fade-in ${isProsecutor ? 'justify-start' : 'justify-end'}">
                    <div class="flex max-w-[85%] md:max-w-[70%] gap-3 ${isProsecutor ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex-shrink-0 flex items-center justify-center border-2 border-slate-700 bg-slate-800 text-lg">
                            ${isProsecutor ? '‚öñÔ∏è' : 'üòà'}
                        </div>
                        <div class="flex flex-col ${isProsecutor ? 'items-start' : 'items-end'}">
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 px-1">
                                ${isProsecutor ? 'Prosecution (AI)' : 'Defense (Apoorva)'}
                            </span>
                            <div class="px-5 py-3 rounded-2xl text-sm md:text-base leading-relaxed ${
                                isProsecutor 
                                    ? 'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700' 
                                    : 'bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-tr-none shadow-lg shadow-purple-500/20'
                            }">
                                ${msg.text}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- LOGIC ---
        
        window.setActiveCase = (id) => {
            if (id) {
                const c = CASES.find(x => x.id === id);
                currentSession = {
                    activeCaseId: id,
                    chatHistory: [{ role: 'prosecutor', text: c.opener || "State your defense." }],
                    credibility: 100,
                    status: 'OPEN',
                    isProcessing: false
                };
                logAction("VIEW_CASE", { caseId: id, caseTitle: c ? c.title : 'Unknown' });
            } else {
                currentSession.activeCaseId = null;
                logAction("NAVIGATE_HOME", {});
            }
            renderApp();
        };

        window.handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.submitDefense();
            }
        };

        window.submitDefense = async () => {
            const input = document.getElementById('chatInput');
            const defenseText = input.value.trim();
            const { activeCaseId, isProcessing, status } = currentSession;
            const activeCase = CASES.find(c => c.id === activeCaseId);

            if (!defenseText || isProcessing || status !== 'OPEN') return;

            // 1. Update User State
            currentSession.isProcessing = true;
            currentSession.chatHistory.push({ role: 'defendant', text: defenseText });
            input.value = '';
            renderApp();
            scrollToBottom();

            // 2. Log User Turn
            logAction("DEFENSE_TURN", { caseId: activeCaseId, text: defenseText });

            try {
                // 3. AI Turn
                const systemInstruction = `
                    You are a Text-Based Roleplay Engine for a "Bestie Court".
                    
                    **Characters**:
                    1. **Prosecutor (You)**: Representing Shashwat (Plaintiff). Witty, sharp, aggressive, dramatic, but funny.
                    2. **Judge (You)**: Fair but tough. Decides credibility scores based on the logic and emotion of the excuse.
                    
                    **Context**:
                    Plaintiff: Shashwat (Dev, Movie Lover, Put in 20 hours for this site).
                    Defendant: Apoorva (Topper, Non-tech, "Gatekeeper").
                    Case: "${activeCase.context}"
                    
                    **Game Logic & Scoring**:
                    - **Bad Excuse** (Vague, dismissing, rude): Decrease Credibility (-10 to -20).
                    - **Okay Excuse** (Standard denial): Small decrease or neutral (-5 to 0).
                    - **Good Excuse** (Logical, witty, or heartfelt apology): INCREASE Credibility (+10 to +20).
                    - **Winning**: If the defendant makes a solid point, valid justification, or a sincere apology that resolves the issue, set "isCaseClosed": true and "verdict": "ACQUITTED".
                    - **Losing**: If Credibility drops to 0, they are GUILTY.
                    
                    BE FAIR. If she gives a good argument, let her win. If she is being manipulative, punish her score.

                    **Output JSON ONLY**:
                    {
                        "prosecutorRebuttal": "Your witty/sarcastic response to her excuse.",
                        "credibilityChange": integer,
                        "isCaseClosed": boolean,
                        "verdict": "GUILTY" | "ACQUITTED" | null
                    }
                `;

                // Provide last 5 turns for context
                const historyContext = currentSession.chatHistory.slice(-5).map(m => `${m.role}: ${m.text}`).join('\n');

                const response = await ai.models.generateContent({
                    model: MODEL_ID,
                    contents: `Chat History:\n${historyContext}\n\nDefendant's Last Reply: "${defenseText}"`,
                    config: {
                        systemInstruction: systemInstruction,
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                prosecutorRebuttal: { type: Type.STRING },
                                credibilityChange: { type: Type.INTEGER },
                                isCaseClosed: { type: Type.BOOLEAN },
                                verdict: { type: Type.STRING, nullable: true }
                            },
                            required: ["prosecutorRebuttal", "credibilityChange", "isCaseClosed"]
                        }
                    }
                });

                const data = JSON.parse(response.text);

                // 4. Process AI Response
                currentSession.credibility = Math.max(0, Math.min(100, currentSession.credibility + data.credibilityChange));
                currentSession.chatHistory.push({ role: 'prosecutor', text: data.prosecutorRebuttal });

                logAction("PROSECUTOR_TURN", { 
                    caseId: activeCaseId, 
                    rebuttal: data.prosecutorRebuttal, 
                    credibilityChange: data.credibilityChange,
                    newCredibility: currentSession.credibility
                });

                if (currentSession.credibility <= 0) {
                    currentSession.status = 'GUILTY';
                    currentSession.isCaseClosed = true;
                    logAction("FINAL_VERDICT", { caseId: activeCaseId, result: 'GUILTY' });
                } else if (data.isCaseClosed) {
                    currentSession.status = data.verdict || 'GUILTY';
                    logAction("FINAL_VERDICT", { caseId: activeCaseId, result: currentSession.status });
                }

            } catch (e) {
                console.error(e);
                currentSession.chatHistory.push({ role: 'prosecutor', text: "Objection! The court stenographer missed that. (API Error)" });
            } finally {
                currentSession.isProcessing = false;
                renderApp();
                scrollToBottom();
            }
        };

        const scrollToBottom = () => {
            const container = document.getElementById('chatContainer');
            if (container) container.scrollTop = container.scrollHeight;
        };

        const renderApp = () => {
            const root = document.getElementById('root');
            
            if (currentSession.activeCaseId) {
                const c = CASES.find(x => x.id === currentSession.activeCaseId);
                const isGuilty = currentSession.status === 'GUILTY';
                const isAcquitted = currentSession.status === 'ACQUITTED';
                const isClosed = isGuilty || isAcquitted;
                
                // Credibility Color
                let credColor = 'bg-green-500';
                if (currentSession.credibility < 60) credColor = 'bg-yellow-500';
                if (currentSession.credibility < 30) credColor = 'bg-red-500';

                root.innerHTML = `
                    <div class="h-[calc(100vh-6rem)] flex flex-col max-w-4xl mx-auto animate-fade-in relative">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-4 shrink-0">
                            <button onclick="window.setActiveCase(null)" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-sm">
                                <span class="text-xl">‚Üê</span> Exit Case
                            </button>
                            <div class="text-center">
                                <h2 class="text-lg md:text-xl font-bold text-white leading-tight">${c.title}</h2>
                                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Case #${c.id.split('-')[1].toUpperCase()}</p>
                            </div>
                            <div class="w-20"></div> <!-- Spacer -->
                        </div>

                        <!-- Credibility Bar -->
                        <div class="mb-6 shrink-0 bg-slate-900/50 p-4 rounded-xl border border-white/5 backdrop-blur-sm">
                            <div class="flex justify-between text-xs font-bold uppercase tracking-wider mb-2">
                                <span class="text-slate-400">Defendant Credibility</span>
                                <span class="${credColor.replace('bg-', 'text-')}">${currentSession.credibility}%</span>
                            </div>
                            <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden shadow-inner">
                                <div class="h-full ${credColor} transition-all duration-700 ease-out relative" style="width: ${currentSession.credibility}%">
                                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Area -->
                        <div id="chatContainer" class="chat-container flex-1 overflow-y-auto px-2 pb-4 scroll-smooth">
                            ${currentSession.chatHistory.map(renderChatMessage).join('')}
                            
                            ${currentSession.isProcessing ? `
                                <div class="flex w-full mb-6 justify-start animate-fade-in">
                                    <div class="flex max-w-[70%] gap-3 items-center">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-slate-700 bg-slate-800 text-sm">‚öñÔ∏è</div>
                                        <div class="flex space-x-1 bg-slate-800 px-4 py-3 rounded-2xl rounded-tl-none border border-slate-700">
                                            <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                                            <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                                            <div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${isClosed ? `
                                <div class="my-8 p-8 rounded-xl text-center border-2 animate-fade-in ${isGuilty ? 'bg-red-900/20 border-red-500' : 'bg-green-900/20 border-green-500'}">
                                    <div class="text-4xl mb-4">${isGuilty ? 'üßë‚Äç‚öñÔ∏è' : 'üïäÔ∏è'}</div>
                                    <h3 class="text-3xl font-bold uppercase mb-2 ${isGuilty ? 'text-red-500' : 'text-green-500'}">
                                        ${isGuilty ? 'GUILTY AS CHARGED' : 'CASE DISMISSED'}
                                    </h3>
                                    <p class="text-slate-300 max-w-md mx-auto mb-6">
                                        ${isGuilty 
                                            ? "The defendant has failed to provide sufficient justification. The court sentences you to buy Shashwat food immediately." 
                                            : "Against all odds, the defendant has proven their case. You are free to go."}
                                    </p>
                                    <button onclick="window.setActiveCase(null)" class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-bold transition-all">Return to Docket</button>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Input Area -->
                        ${!isClosed ? `
                            <div class="mt-4 shrink-0 relative">
                                <input type="text" id="chatInput" 
                                    onkeypress="window.handleKeyPress(event)"
                                    class="w-full bg-slate-900/80 border border-slate-700 rounded-xl py-4 pl-5 pr-14 text-white placeholder:text-slate-600 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all shadow-lg backdrop-blur-md"
                                    placeholder="Type your defense here..." 
                                    ${currentSession.isProcessing ? 'disabled' : ''}
                                    autocomplete="off"
                                />
                                <button onclick="window.submitDefense()" 
                                    class="absolute right-2 top-2 p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    ${Icons.Send}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Auto scroll on render
                setTimeout(scrollToBottom, 100);

            } else {
                // DASHBOARD VIEW
                root.innerHTML = `
                    <div class="animate-fade-in">
                        <header class="text-center mb-12">
                            <h1 class="text-4xl md:text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-rose-400 cursor-pointer">The Bestie Court</h1>
                            <p class="text-slate-400 mt-2 text-sm uppercase tracking-widest">Shashwat vs. Apoorva</p>
                        </header>

                        <div class="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-12 mb-20">
                            ${renderProfileCard(shashwatStats, 'left')}
                            <div class="flex flex-col items-center justify-center text-slate-500 font-mono text-xs md:text-sm shrink-0">
                                <span class="h-16 w-px bg-gradient-to-b from-transparent via-slate-600 to-transparent mb-2"></span>
                                <span class="bg-slate-900 px-2 py-1 rounded border border-slate-800">VS</span>
                                <span class="h-16 w-px bg-gradient-to-b from-transparent via-slate-600 to-transparent mt-2"></span>
                            </div>
                            ${renderProfileCard(apoorvaStats, 'right')}
                        </div>

                        <div class="max-w-6xl mx-auto">
                            <div class="flex items-center gap-4 mb-8">
                                <div class="h-px bg-slate-800 flex-1"></div>
                                <h3 class="text-xl font-bold text-slate-400 uppercase tracking-widest">Active Docket (${CASES.length})</h3>
                                <div class="h-px bg-slate-800 flex-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${CASES.map(renderCaseCard).join('')}
                            </div>
                        </div>

                        <footer class="text-center text-slate-600 mt-20 pb-8 text-sm">
                            <p>Made with üíú and pure Java logic by Shashwat</p>
                        </footer>
                    </div>
                `;
            }
        };

        // Inject Evidence Component flag manually for the specific case
        CASES.find(c => c.id === 'case-gatekeeping').evidenceComponent = true;

        // Init
        renderApp();
    </script>
</body>
</html>
